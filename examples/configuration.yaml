# Example configuration for CAP Alerts integration

# This integration is configured through the Home Assistant UI.
# Below are examples for reference:

# Example 1: CHMI (Czech Republic) - All alerts
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: (leave empty for all alerts)
# Update Interval: 300

# Example 2: CHMI - Prague only
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: Prague
# Update Interval: 300

# Example 3: CHMI - Central Bohemia region
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: Bohemia
# Update Interval: 300

# After configuration, you'll get a sensor entity:
# sensor.cap_alerts_alert
# State: 'off' when no alerts, or awareness level (yellow/orange/red) when active
# Attributes: awareness_level, awareness_type, alert_count, alerts

# Use in automations:
automation:
  - alias: "Severe Weather Alert Notification (using awareness level)"
    trigger:
      - platform: state
        entity_id: sensor.cap_alerts_alert
        to:
          - orange
          - red
    action:
      - service: notify.mobile_app
        data:
          title: "⚠️ Weather Alert!"
          message: >
            {{ state_attr('sensor.cap_alerts_alert', 'awareness_type') }}
            Level: {{ states('sensor.cap_alerts_alert') | upper }}
            Active alerts: {{ state_attr('sensor.cap_alerts_alert', 'alert_count') }}

  - alias: "Severe Weather Alert Notification (using alert count)"
    trigger:
      - platform: state
        entity_id: sensor.cap_alerts_alert
    condition:
      - condition: numeric_state
        entity_id: sensor.cap_alerts_alert
        attribute: alert_count
        above: 0
      - condition: template
        value_template: >
          {% set alerts = state_attr('sensor.cap_alerts_alert', 'alerts') %}
          {{ alerts and alerts[0].severity in ['Severe', 'Extreme'] }}
    action:
      - service: notify.mobile_app
        data:
          title: "⚠️ Weather Alert!"
          message: >
            {% set alert = state_attr('sensor.cap_alerts_alert', 'alerts')[0] %}
            {{ alert.headline }}
            
            Severity: {{ alert.severity }}
            Areas: {{ alert.area }}

  - alias: "Clear Weather Alert"
    trigger:
      - platform: state
        entity_id: sensor.cap_alerts_alert
        to: "off"
    action:
      - service: notify.mobile_app
        data:
          title: "✅ Weather Alert Cleared"
          message: "All weather alerts have been cleared."
