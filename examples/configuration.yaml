# Example configuration for CAP Alerts integration

# This integration is configured through the Home Assistant UI.
# Below are examples for reference:

# Example 1: CHMI (Czech Republic) - All alerts
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: (leave empty for all alerts)
# Update Interval: 300

# Example 2: CHMI - Prague only
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: Prague
# Update Interval: 300

# Example 3: CHMI - Central Bohemia region
# Feed URL: https://vystrahy-cr.chmi.cz/data/XOCZ50_OKPR.xml
# Area Filter: Bohemia
# Update Interval: 300

# After configuration, you'll get a binary sensor entity:
# binary_sensor.cap_alerts_alert
# State: 'on' when alerts are active, 'off' when no alerts
# Attributes: awareness_level, awareness_type, alert_count, alerts

# Use in automations:
automation:
- alias: Severe Weather Alert Notification (using awareness level)
  trigger:
  - platform: state
    entity_id: binary_sensor.cap_alerts_alert
    to: on
  condition:
  - condition: template
    value_template: >
      {# Check for Orange (3) or Red (4) awareness levels #}
      {% set level = state_attr('binary_sensor.cap_alerts_alert', 'awareness_level') %}
      {{ level and (level.startswith('3;') or level.startswith('4;')) }}
  action:
  - service: notify.mobile_app
    data:
      title: ⚠️ Weather Alert!
      message: >
        {{ state_attr('binary_sensor.cap_alerts_alert', 'awareness_type') }}
        Active alerts: {{ state_attr('binary_sensor.cap_alerts_alert', 'alert_count') }}

- alias: Severe Weather Alert Notification (using alert details)
  trigger:
  - platform: state
    entity_id: binary_sensor.cap_alerts_alert
    to: on
  condition:
  - condition: template
    value_template: >
      {% set alerts = state_attr('binary_sensor.cap_alerts_alert', 'alerts') %}
      {{ alerts and alerts[0].severity in ['Severe', 'Extreme'] }}
  action:
  - service: notify.mobile_app
    data:
      title: ⚠️ Weather Alert!
      message: >
        {% set alert = state_attr('binary_sensor.cap_alerts_alert', 'alerts')[0] %}
        {{ alert.headline }}

        Severity: {{ alert.severity }}
        Areas: {{ alert.area }}

- alias: Clear Weather Alert
  trigger:
  - platform: state
    entity_id: binary_sensor.cap_alerts_alert
    to: off
  action:
  - service: notify.mobile_app
    data:
      title: ✅ Weather Alert Cleared
      message: All weather alerts have been cleared.
